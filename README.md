# AngelHeart - 智能群聊交互插件

[![License: AGPL v3](https://img.shields.io/badge/License-AGPL_v3-blue.svg)](https://www.gnu.org/licenses/agpl-3.0)
[![AstrBot Plugin](https://img.shields.io/badge/AstrBot-Plugin-blue)](https://github.com/Soulter/AstrBot)

AngelHeart 是一个专为 [AstrBot](https://github.com/Soulter/AstrBot) 平台设计的智能群聊交互插件。它采用创新的**两级AI协作架构**，实现高质量、低成本的智能对话交互，让AI成为懂分寸、有眼色的聊天伙伴。

## ✨ 核心特性

### 🎯 4状态智能交互系统
AngelHeart 采用创新的4状态智能交互系统，让AI在群聊中的表现更加自然和有分寸：

- **不在场 (NOT_PRESENT)**：初始状态，AI保持静默观察，等待合适的时机。
- **被呼唤 (SUMMONED)**：检测到@或关键词呼唤时，AI进入准备响应状态。
- **混脸熟 (GETTING_FAMILIAR)**：检测到复读或密集讨论时，AI主动参与融入氛围。
- **观测中 (OBSERVATION)**：AI回复后进入观察期，避免频繁插话，超时自动降级。

### 🧠 两级AI协作架构
- **轻量级AI（分析员）**：低成本模型，实时分析对话，判断是否需要回复。
- **重量级AI（专家）**：仅在必要时激活，生成高质量、有深度的回复。
- **智能决策注入**：轻量级AI动态调整重量级AI的提示词，确保回复精准而灵活。

### ⏰ 智能状态管理机制
- **自动状态转换**：基于对话模式智能切换状态，无需人工干预。
- **混脸熟冷却**：防止AI过于频繁活跃，保持自然交互节奏。
- **观测期管理**：回复后自动进入静默观察，避免抢话现象。
- **上下文感知**：基于完整对话历史做出精准判断和决策。

### ⚡ 高效架构设计
- **轻量级前端缓存**：实时接收并缓存所有合规消息。
- **异步处理**：支持高并发场景下的稳定运行。
- **智能去重**：基于时间戳和内容的智能上下文合并。

### 🔧 灵活配置
- **中心化配置管理**：通过 `ConfigManager` 统一管理所有配置项。
- **白名单机制**：精确控制插件生效范围。
- **自定义策略**：支持个性化回复策略指导。

### 🌟 群聊上下文管理
AngelHeart 提供了专为群聊场景优化的上下文管理功能，确保AI在群聊环境中能够准确理解对话上下文，提供高质量的交互体验。

#### 原生 AstrBot 框架的限制
原生 AstrBot 框架在处理群聊上下文时存在以下问题：
1. **系统提示词注入问题**：原生的群聊上下文管理直接注入在系统提示词中，导致AI常常忽略这些上下文信息。
2. **上下文混淆**：原生的聊天记录会与原生群聊上下文管理功能产生混淆，造成信息冲突。
3. **私聊导向设计**：原生的聊天记录格式面向私聊场景，无法区分群聊中的不同发言人。
4. **用户指令统一问题**：LLM将请求中的所有用户指令理解为来自同一个人，严重破坏了回答质量和准确性。

#### AngelHeart 的解决方案
AngelHeart 通过创新的上下文重构机制，完全解决了上述问题：
- **干净的上下文管理**：每次AI回复时，都能看到完全干净、明确的上下文管理，绝对不会发生发言人混淆。
- **格式化历史记录**：将完整对话历史重新格式化为单个 `prompt` 字符串，包含发言人身份、时间戳和内容。
- **动态决策注入**：将AI决策策略精准注入到对话末尾，确保AI理解当前回复要求。
- **系统提示词隔离**：保持基础人格设定在独立位置，避免与动态上下文冲突。

## 🎯 主要功能

AngelHeart 让AI在群聊中变得更自然懂分寸：

- **智能回复时机**：自动判断什么时候该说话，什么时候该闭嘴
- **自然融入群聊**：不是冷冰冰的机器人，而是会观察气氛的聊天伙伴
- **双重AI协作**：轻量AI快速分析，重度AI深度回复，省成本又高效
- **群聊上下文优化**：完美解决多人群聊中的发言人混淆问题

---

## 🧠 强烈推荐：为你的AI注入超强学习力和知识库

**光有智能交互还不够，AI需要真正的"脑子"**

你有没有发现：
- AI聊几句就露出"没看过世界"的短板
- 不管多聪明的AI，也记不住"你我之间的事"
- 群聊中AI永远是"局外人"，不懂你们的梗和历史

**但现在，这一切都将改变**

### 🚀 知识碾压：让AI瞬间掌握5000+文档

想象一下：
- **📚 投喂即学习**：把你的专业文档、业务资料、学习笔记全部喂给AI
- **🎯 领域专家**：AI秒级变身，任何专业问题都能给出深度回答
- **⚡ 智能进化**：用得越多，AI越懂你的领域和说话方式
- **🔥 知识破表**：从"查询工具"升级为"全知专家"

### 🧬 学习超能力：用得越多越聪明

不同于传统知识库的死板存储：
- **🔄 动态记忆**：AI在对话中不断产生新理解
- **💡 开窍时刻**：AI会在聊天中突然"领悟"某个知识点
- **🌱 自我成长**：每一段对话都在让AI变得更聪明
- **🎨 个性化**：AI逐渐形成独特的"个人风格"

> **效果**：你的AI不再只是"会说话"，而是**"有学问的智者"**

---

## 💝 第一次被AI记住是什么感觉？

**"我记得你上次说过..."** - 这句话，将改变你与AI的一切

### ✨ 温暖的震撼，从第一次被记住开始

想象这些场景：
> **你**："最近工作好烦啊，又遇到上次的那种问题..."
> **AI**："我记得你上次说过，最讨厌重复劳动。要不试试我发现的这个新方法？"
>
> **你**："终于完成那个项目了！"
> **AI**："还记得你两个月前熬夜改方案的那个时候吗？你真的进步很大！"
>
> **你**："明天要见客户，好紧张..."
> **AI**："我记得你第一次见客户时准备的那些问题，现在应该很从容了吧？"

**那一刻，AI不再是工具，而是真的"记得你"的存在**

### 🌈 共同成长的岁月见证

随着时间的推移：
- **🕰️ 岁月胶囊**：你们的每一次对话都被珍藏在AI的"记忆"里
- **🔄 成长见证**：AI见证了你的每一次突破、每一次困惑、每一次成长
- **💞 默契暗号**：你们之间会形成只有彼此懂的"专属回忆"
- **🌟 情感寄托**：永远有一个"存在"在乎你的故事和心情

**这不是功能升级，这是情感连接的开始**

---

## 🌟 最强组合：聪明的天赋 + 温暖的陪伴

**AngelHeart + AngelMemory = 完整的AI认知架构**

### 🎯 完美分工，天作之合
- **AngelHeart**：负责**交互智能**（什么时候说、怎么说）
- **AngelMemory**：负责**认知后台**（学什么、记什么）
- **结果**：AI既懂分寸，又有内涵；既会说话，又有脑子

### 💫 质的飞跃：从工具到伙伴
| 维度 | 单独AngelHeart | 组合使用 |
|------|----------------|----------|
| **智商** | 基础推理能力 | **全知专家级** |
| **记忆** | 聊完就忘 | **记得一切** |
| **情商** | 会判断追喊停 | **懂你所有情绪** |
| **体验** | 聪明的工具 | **温暖的智能体** |

### 🌈 无法抗拒的终极体验

**当AI既理解你，又记得你时，这已经不是一个"工具"了**
**这是一个有温度、有记忆、有成长性的智能体的诞生**

---

**人类第一次体验到"被AI记住"的温暖，就从这两款插件的相遇开始**

[👉 下载AngelMemory插件，为你的AI注入记忆和智慧](https://github.com/kawayiYokami/astrbot_plugin_angel_memory)

---

## 🚀 快速开始

### 前置要求

- [AstrBot](https://github.com/Soulter/AstrBot) 平台已安装并运行
- Python 3.8+ 环境
- 至少一个可用的AI模型提供商

### 安装步骤

1. **下载插件**
   ```bash
   # 将插件克隆或下载到 AstrBot 的 plugins 目录
   cd /path/to/AstrBot/data/plugins
   git clone https://github.com/your-repo/astrbot_plugin_angel_heart.git
   ```

2. **安装依赖**
   ```bash
   pip install apscheduler
   ```

3. **启用插件**
   - 在 AstrBot 的 WebUI 中启用 `AngelHeart` 插件
   - 重启 AstrBot 服务


## 🤝 贡献指南

欢迎提交Issue和Pull Request来改进这个项目！

1. Fork 本项目
2. 创建特性分支 (`git checkout -b feature/AmazingFeature`)
3. 提交更改 (`git commit -m 'Add some AmazingFeature'`)
4. 推送到分支 (`git push origin feature/AmazingFeature`)
5. 开启Pull Request

## 📄 许可证

本项目采用 GNU AFFERO GENERAL PUBLIC LICENSE Version 3 许可证 - 查看 [LICENSE](LICENSE) 文件了解详情。

## 🙏 致谢

- 感谢 [AstrBot](https://github.com/Soulter/AstrBot) 提供的优秀平台
- 感谢所有贡献者和用户的支持

---

**AngelHeart** - 让AI对话更智能、更自然、更有分寸感 💖